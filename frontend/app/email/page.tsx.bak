'use client'

import React, { useState, useEffect } from 'react'
import axios from 'axios'
import NextLink from 'next/link'
import { useBranding } from '@/lib/branding-context'
import { getAuthToken } from '@/lib/auth'
import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import TextAlign from '@tiptap/extension-text-align'
import ImageExtension from '@tiptap/extension-image'
import LinkExtension from '@tiptap/extension-link'

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'

interface EmailAccount {
  id: number
  email_address: string
  account_name: string
  display_name?: string
  is_active: boolean
  last_sync?: string
}

interface Email {
  id: number
  thread_id?: number
  subject: string
  from_address: string
  to_address: string
  cc?: string
  bcc?: string
  body_html?: string
  body_text?: string
  received_at: string
  is_read: boolean
  is_starred: boolean
  is_sent: boolean
  in_reply_to?: string
  attachments?: Array<{
    id?: number
    filename: string
    size: number
    content_type?: string
    url?: string
  }>
}

interface EmailThread {
  id: number
  subject: string
  from_address: string
  to_addresses: string
  has_unread: boolean
  is_archived: boolean
  is_starred: boolean
  reply_count: number
  first_email_at: string
  last_email_at: string
  emails: Email[]
}

export default function EmailPage() {
  const brandingContext = useBranding()
  let branding = brandingContext?.branding
  
  // Fallback to defaults if branding is not loaded
  if (!branding) {
    branding = {
      company_name: 'Social Media Messenger',
      company_description: 'Unified messaging platform',
      logo_url: null,
      favicon_url: null,
      primary_color: '#2563eb',
      secondary_color: '#1e40af',
      accent_color: '#3b82f6',
      support_url: null,
      privacy_url: null,
      terms_url: null,
      timezone: 'UTC',
    }
  }
  
  const [account, setAccount] = useState<EmailAccount | null>(null)
  const [threads, setThreads] = useState<EmailThread[]>([])
  const [filteredThreads, setFilteredThreads] = useState<EmailThread[]>([])
  const [selectedThread, setSelectedThread] = useState<EmailThread | null>(null)
  const [loading, setLoading] = useState(false)
  const [showCompose, setShowCompose] = useState(false)
  const [currentFolder, setCurrentFolder] = useState<'inbox' | 'sent' | 'drafts' | 'outbox' | 'trash'>('inbox')
  const [searchQuery, setSearchQuery] = useState('')

  // Fetch email account
  useEffect(() => {
    fetchAccount()
  }, [])

  // Fetch emails when folder changes
  useEffect(() => {
    fetchEmails()
  }, [currentFolder])

  // Auto-sync emails every 30 seconds for inbox
  useEffect(() => {
    if (!account || currentFolder !== 'inbox') return

    const interval = setInterval(() => {
      syncEmails()
    }, 30000)

    return () => clearInterval(interval)
  }, [account, currentFolder])

  // Filter threads based on search query
  useEffect(() => {
    if (!searchQuery.trim()) {
      setFilteredThreads(threads)
      return
    }

    const query = searchQuery.toLowerCase()
    const filtered = threads.filter((thread) => {
      // Search in subject
      if (thread.subject.toLowerCase().includes(query)) return true
      
      // Search in from/to address
      if (currentFolder === 'sent') {
        if (thread.to_addresses.toLowerCase().includes(query)) return true
      } else {
        if (thread.from_address.toLowerCase().includes(query)) return true
      }
      
      // Search in email body
      if (thread.emails.some(email => {
        const bodyText = (email.body_html || email.body_text || '').toLowerCase()
        return bodyText.includes(query)
      })) return true
      
      return false
    })
    
    setFilteredThreads(filtered)
  }, [searchQuery, threads])

  const fetchAccount = async () => {
    try {
      const token = getAuthToken()
      if (!token) {
        console.log('No auth token, skipping account fetch')
        return
      }
      const response = await axios.get(`${API_URL}/email/account`, {
        headers: { Authorization: `Bearer ${token}` }
      })
      setAccount(response.data)
    } catch (error: any) {
      if (error.response?.status === 404) {
        console.log('No email account configured')
      } else if (error.response?.status === 401) {
        console.log('Not authenticated, will use default account')
      } else {
        console.error('Error fetching account:', error)
      }
    }
  }

  const fetchEmails = async () => {
    if (!account) return
    try {
      setLoading(true)
      setSelectedThread(null)
      const token = getAuthToken()
      let endpoint: string
      switch (currentFolder) {
        case 'sent':
          endpoint = '/email/sent'
          break
        case 'drafts':
          endpoint = '/email/drafts'
          break
        case 'outbox':
          endpoint = '/email/outbox'
          break
        case 'trash':
          endpoint = '/email/trash'
          break
        default:
          endpoint = '/email/inbox'
      }
      console.log(`Fetching from ${endpoint}...`)
      const response = await axios.get(`${API_URL}${endpoint}?limit=50`, {
        headers: { Authorization: `Bearer ${token}` }
      })
      
      if (!response.data || !response.data.emails) {
        console.warn('No emails data received from API')
        setThreads([])
        return
      }
      
      // For now, treat each email as a separate thread
      const threadedEmails = response.data.emails.map((email: Email) => ({
        id: email.thread_id || email.id,
        subject: email.subject || '(No subject)',
        from_address: email.from_address,
        to_addresses: email.to_address,
        has_unread: !email.is_read,
        is_archived: false,
        is_starred: email.is_starred,
        reply_count: 0,
        first_email_at: email.received_at,
        last_email_at: email.received_at,
        emails: [email]
      }))
      console.log(`Loaded ${threadedEmails.length} emails from ${currentFolder}`)
      setThreads(threadedEmails)
    } catch (error: any) {
      console.error(`Error fetching ${currentFolder} emails:`, error.response?.status, error.message)
      // Only show alert for actual connection errors, not validation errors
      if (error.response?.status === 401) {
        alert('Authentication failed. Please log in again.')
      } else if (error.response?.status === 404) {
        console.log('No email account found, but this is normal')
      } else if (!error.response) {
        alert('Failed to connect to email server. Please check your connection.')
      }
    } finally {
      setLoading(false)
    }
  }

  const syncEmails = async () => {
    if (!account) return

    try {
      setLoading(true)
      const token = getAuthToken()
      await axios.post(`${API_URL}/email/account/sync`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      })
      await fetchEmails()
    } catch (error) {
      console.error('Error syncing emails:', error)
    } finally {
      setLoading(false)
    }
  }

  if (!branding) {
    return <div className="text-center mt-10">Loading...</div>
  }

  return (
    <div className="h-screen bg-gray-100 flex flex-col">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 p-4 space-y-3">
        <div className="flex justify-between items-start">
          <div>
            <h1 className="text-2xl font-bold" style={{ color: branding.primary_color }}>
              üìß Email
            </h1>
            {account && (
              <p className="text-sm text-gray-600">{account.email_address}</p>
            )}
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setShowCompose(true)}
              className="px-4 py-2 text-white rounded-lg hover:opacity-90 whitespace-nowrap"
              style={{ backgroundColor: branding.primary_color }}
            >
              ‚úèÔ∏è Compose
            </button>
            <button
              onClick={syncEmails}
              disabled={loading}
              className="px-4 py-2 rounded-lg hover:opacity-90 disabled:opacity-50 whitespace-nowrap"
              style={{ backgroundColor: branding.secondary_color, color: 'white' }}
            >
              üîÑ Sync
            </button>
          </div>
        </div>
        
        {/* Search Bar */}
        <div className="flex gap-2">
          <input
            type="text"
            placeholder="üîç Search emails by subject, sender, or content..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:border-transparent"
            style={{ '--tw-ring-color': branding.primary_color } as React.CSSProperties}
          />
          {searchQuery && (
            <button
              onClick={() => setSearchQuery('')}
              className="px-3 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition"
              title="Clear search"
            >
              ‚úï
            </button>
          )}
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 flex overflow-hidden">
        {/* Thread List */}
        <div className="w-96 bg-white border-r border-gray-200 overflow-y-auto">
          <div className="sticky top-0 bg-white border-b border-gray-200 p-4 space-y-2">
            <h2 className="font-semibold">Folders</h2>
            <div className="flex flex-col gap-2">
              <button
                onClick={() => {
                  setCurrentFolder('inbox')
                  setSelectedThread(null)
                }}
                className={`w-full px-3 py-2 rounded-lg text-sm transition text-left ${
                  currentFolder === 'inbox'
                    ? 'text-white'
                    : 'text-gray-600 border border-gray-300 hover:bg-gray-50'
                }`}
                style={{
                  backgroundColor: currentFolder === 'inbox' ? branding.primary_color : 'transparent'
                }}
              >
                üì• Inbox
              </button>
              <button
                onClick={() => {
                  setCurrentFolder('drafts')
                  setSelectedThread(null)
                }}
                className={`w-full px-3 py-2 rounded-lg text-sm transition text-left ${
                  currentFolder === 'drafts'
                    ? 'text-white'
                    : 'text-gray-600 border border-gray-300 hover:bg-gray-50'
                }`}
                style={{
                  backgroundColor: currentFolder === 'drafts' ? branding.primary_color : 'transparent'
                }}
              >
                ‚úèÔ∏è Drafts
              </button>
              <button
                onClick={() => {
                  setCurrentFolder('outbox')
                  setSelectedThread(null)
                }}
                className={`w-full px-3 py-2 rounded-lg text-sm transition text-left ${
                  currentFolder === 'outbox'
                    ? 'text-white'
                    : 'text-gray-600 border border-gray-300 hover:bg-gray-50'
                }`}
                style={{
                  backgroundColor: currentFolder === 'outbox' ? branding.primary_color : 'transparent'
                }}
              >
                ‚è≥ Outbox
              </button>
              <button
                onClick={() => {
                  setCurrentFolder('sent')
                  setSelectedThread(null)
                }}
                className={`w-full px-3 py-2 rounded-lg text-sm transition text-left ${
                  currentFolder === 'sent'
                    ? 'text-white'
                    : 'text-gray-600 border border-gray-300 hover:bg-gray-50'
                }`}
                style={{
                  backgroundColor: currentFolder === 'sent' ? branding.primary_color : 'transparent'
                }}
              >
                üì§ Sent
              </button>
              <button
                onClick={() => {
                  setCurrentFolder('trash')
                  setSelectedThread(null)
                }}
                className={`w-full px-3 py-2 rounded-lg text-sm transition text-left ${
                  currentFolder === 'trash'
                    ? 'text-white'
                    : 'text-gray-600 border border-gray-300 hover:bg-gray-50'
                }`}
                style={{
                  backgroundColor: currentFolder === 'trash' ? branding.primary_color : 'transparent'
                }}
              >
                üóëÔ∏è Trash
              </button>
            </div>
          </div>
          <div className="sticky top-[100px] bg-white border-b border-gray-200 p-4">
            <h3 className="font-semibold text-sm">
              {currentFolder === 'sent' && 'Sent'}
              {currentFolder === 'drafts' && 'Drafts'}
              {currentFolder === 'outbox' && 'Outbox'}
              {currentFolder === 'trash' && 'Trash'}
              {currentFolder === 'inbox' && 'Inbox'}
            </h3>
            <p className="text-xs text-gray-500 mt-1">{filteredThreads.length} {currentFolder === 'sent' ? 'emails' : 'conversations'}</p>
          </div>

          {loading && filteredThreads.length === 0 ? (
            <div className="p-4 text-center text-gray-500">Loading emails...</div>
          ) : filteredThreads.length === 0 ? (
            <div className="p-4 text-center text-gray-500">{searchQuery ? 'No emails match your search' : 'No emails yet'}</div>
          ) : (
            <div className="divide-y">
              {filteredThreads.map((thread) => (
                <button
                  key={thread.id}
                  onClick={() => setSelectedThread(thread)}
                  className={`w-full text-left px-4 py-3 transition border-l-4 ${
                    thread.has_unread 
                      ? 'bg-gradient-to-r from-amber-50 to-yellow-50 border-l-amber-500 hover:from-amber-100 hover:to-yellow-100 shadow-sm'
                      : selectedThread?.id === thread.id
                      ? 'bg-gray-100 border-l-gray-300'
                      : 'bg-white border-l-transparent hover:bg-gray-50'
                  }`}
                >
                  <div className="flex justify-between items-start gap-2">
                    <div className="flex-1 min-w-0">
                      <div className={`text-sm truncate flex items-center gap-2 ${
                        thread.has_unread 
                          ? 'font-bold text-gray-900' 
                          : 'font-medium text-gray-700'
                      }`}>
                        {thread.subject}
                        {thread.has_unread && (
                          <span className="flex items-center gap-1 flex-shrink-0">
                            <span className="w-3 h-3 bg-amber-500 rounded-full animate-pulse"></span>
                            <span className="text-xs font-bold bg-amber-500 text-white px-2.5 py-1 rounded-full whitespace-nowrap">NEW</span>
                          </span>
                        )}
                      </div>
                      <div className={`text-xs truncate mt-1 ${
                        thread.has_unread 
                          ? 'font-semibold text-gray-700' 
                          : 'text-gray-500'
                      }`}>
                        {currentFolder === 'sent' ? 'To: ' : 'From: '}
                        {currentFolder === 'sent' ? thread.to_addresses : thread.from_address}
                      </div>
                      <div className={`text-xs mt-1 ${
                        thread.has_unread
                          ? 'text-amber-600 font-medium'
                          : 'text-gray-400'
                      }`}>
                        {new Date(thread.last_email_at).toLocaleString()}
                      </div>
                    </div>
                    <div className="flex gap-2 flex-shrink-0">
                      {thread.is_starred && <span className="text-lg">‚≠ê</span>}
                      {thread.emails.some(e => e.attachments && e.attachments.length > 0) && <span className="text-lg">üìé</span>}
                    </div>
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>

        {/* Email Thread Details or Compose */}
        <div className="flex-1 bg-gray-50 overflow-y-auto">
          {showCompose && (
            <ComposeEmail
              account={account || { id: 0, email_address: 'unknown@example.com', account_name: 'Default', display_name: 'User', is_active: true }}
              branding={branding}
              onClose={() => setShowCompose(false)}
              onSent={() => {
                fetchEmails()
                setShowCompose(false)
              }}
            />
          ) : selectedThread ? (
            <EmailThreadView
              thread={selectedThread}
              account={account || { id: 0, email_address: 'unknown@example.com', account_name: 'Default', display_name: 'User', is_active: true }}
              branding={branding}
              onReplySuccess={() => fetchEmails()}
              currentFolder={currentFolder}
            />
          ) : (
            <div className="h-full flex items-center justify-center text-gray-500">
              Select a conversation to read
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

// Compose Email Component
function ComposeEmail({ account, branding, onClose, onSent }: any) {
  const [toAddresses, setToAddresses] = useState<string[]>([])
  const [toInput, setToInput] = useState('')
  const [ccAddresses, setCcAddresses] = useState<string[]>([])
  const [ccInput, setCcInput] = useState('')
  const [bccAddresses, setBccAddresses] = useState<string[]>([])
  const [bccInput, setBccInput] = useState('')
  const [subject, setSubject] = useState('')
  const [body, setBody] = useState('')
  const [attachments, setAttachments] = useState<File[]>([])
  const [sending, setSending] = useState(false)
  const fileInputRef = React.useRef<HTMLInputElement>(null)

  const isValidEmail = (email: string) => {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim())
  }

  const addToAddress = (address: string) => {
    const trimmed = address.trim()
    if (trimmed && isValidEmail(trimmed) && !toAddresses.includes(trimmed)) {
      setToAddresses([...toAddresses, trimmed])
      setToInput('')
    }
  }

  const addCcAddress = (address: string) => {
    const trimmed = address.trim()
    if (trimmed && isValidEmail(trimmed) && !ccAddresses.includes(trimmed)) {
      setCcAddresses([...ccAddresses, trimmed])
      setCcInput('')
    }
  }

  const addBccAddress = (address: string) => {
    const trimmed = address.trim()
    if (trimmed && isValidEmail(trimmed) && !bccAddresses.includes(trimmed)) {
      setBccAddresses([...bccAddresses, trimmed])
      setBccInput('')
    }
  }

  const removeToAddress = (address: string) => {
    setToAddresses(toAddresses.filter(addr => addr !== address))
  }

  const removeCcAddress = (address: string) => {
    setCcAddresses(ccAddresses.filter(addr => addr !== address))
  }

  const removeBccAddress = (address: string) => {
    setBccAddresses(bccAddresses.filter(addr => addr !== address))
  }

  const handleAddAttachment = (files: FileList | null) => {
    if (files) {
      setAttachments([...attachments, ...Array.from(files)])
    }
  }

  const removeAttachment = (index: number) => {
    setAttachments(attachments.filter((_, i) => i !== index))
  }

  const handleSend = async () => {
    if (toAddresses.length === 0 || !subject) {
      alert('Please fill in To and Subject')
      return
    }

    try {
      setSending(true)
      const token = getAuthToken()
      
      const formData = new FormData()
      formData.append('to_address', toAddresses.join(';'))
      if (ccAddresses.length > 0) {
        formData.append('cc_address', ccAddresses.join(';'))
      }
      if (bccAddresses.length > 0) {
        formData.append('bcc_address', bccAddresses.join(';'))
      }
      formData.append('subject', subject)
      formData.append('body', body)
      
      attachments.forEach((file) => {
        formData.append('attachments', file)
      })

      await axios.post(`${API_URL}/email/send`, formData, {
        headers: { 
          Authorization: `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      })
      onSent()
    } catch (error) {
      console.error('Error sending email:', error)
      alert('Failed to send email')
    } finally {
      setSending(false)
    }
  }

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-lg font-bold">Compose Email</h2>
        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
      </div>

      <div className="space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">From</label>
          <input
            type="email"
            value={account.email_address}
            disabled
            className="w-full px-3 py-2 border rounded-lg bg-gray-100"
          />
        </div>

        {/* To Field */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">To</label>
          <div className="space-y-2">
            <div className="flex gap-2">
              <input
                type="email"
                value={toInput}
                onChange={(e) => setToInput(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    e.preventDefault()
                    addToAddress(toInput)
                  }
                }}
                placeholder="recipient@example.com"
                className="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2"
                style={{ focusRingColor: branding.primary_color }}
              />
              <button
                onClick={() => addToAddress(toInput)}
                className="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm font-medium"
              >
                Add
              </button>
            </div>
            {toAddresses.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {toAddresses.map((addr) => (
                  <span
                    key={addr}
                    className="inline-flex items-center gap-2 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm"
                  >
                    {addr}
                    <button
                      onClick={() => removeToAddress(addr)}
                      className="text-blue-600 hover:text-blue-800 font-bold"
                    >
                      √ó
                    </button>
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* CC Field */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">CC</label>
          <div className="space-y-2">
            <div className="flex gap-2">
              <input
                type="email"
                value={ccInput}
                onChange={(e) => setCcInput(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    e.preventDefault()
                    addCcAddress(ccInput)
                  }
                }}
                placeholder="cc@example.com"
                className="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2"
                style={{ focusRingColor: branding.primary_color }}
              />
              <button
                onClick={() => addCcAddress(ccInput)}
                className="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm font-medium"
              >
                Add
              </button>
            </div>
            {ccAddresses.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {ccAddresses.map((addr) => (
                  <span
                    key={addr}
                    className="inline-flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm"
                  >
                    {addr}
                    <button
                      onClick={() => removeCcAddress(addr)}
                      className="text-green-600 hover:text-green-800 font-bold"
                    >
                      √ó
                    </button>
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* BCC Field */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">BCC</label>
          <div className="space-y-2">
            <div className="flex gap-2">
              <input
                type="email"
                value={bccInput}
                onChange={(e) => setBccInput(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    e.preventDefault()
                    addBccAddress(bccInput)
                  }
                }}
                placeholder="bcc@example.com"
                className="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2"
                style={{ focusRingColor: branding.primary_color }}
              />
              <button
                onClick={() => addBccAddress(bccInput)}
                className="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm font-medium"
              >
                Add
              </button>
            </div>
            {bccAddresses.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {bccAddresses.map((addr) => (
                  <span
                    key={addr}
                    className="inline-flex items-center gap-2 bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm"
                  >
                    {addr}
                    <button
                      onClick={() => removeBccAddress(addr)}
                      className="text-purple-600 hover:text-purple-800 font-bold"
                    >
                      √ó
                    </button>
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Subject</label>
          <input
            type="text"
            value={subject}
            onChange={(e) => setSubject(e.target.value)}
            placeholder="Email subject"
            className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2"
            style={{ focusRingColor: branding.primary_color }}
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Message</label>
          <textarea
            value={body}
            onChange={(e) => setBody(e.target.value)}
            placeholder="Write your email..."
            rows={8}
            className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2"
            style={{ focusRingColor: branding.primary_color }}
          />
        </div>

        {/* Attachments */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Attachments</label>
          <div className="space-y-3">
            <button
              onClick={() => fileInputRef.current?.click()}
              className="w-full px-4 py-2 border-2 border-dashed rounded-lg text-gray-600 hover:border-gray-400 hover:bg-gray-50"
            >
              üìé Add Attachment
            </button>
            <input
              ref={fileInputRef}
              type="file"
              multiple
              onChange={(e) => handleAddAttachment(e.target.files)}
              className="hidden"
            />
            {attachments.length > 0 && (
              <div className="space-y-2">
                {attachments.map((file, index) => (
                  <div
                    key={index}
                    className="flex items-center justify-between bg-gray-100 p-2 rounded"
                  >
                    <div className="flex items-center gap-2">
                      <span>üìÑ</span>
                      <div>
                        <div className="text-sm font-medium">{file.name}</div>
                        <div className="text-xs text-gray-500">
                          {(file.size / 1024).toFixed(2)} KB
                        </div>
                      </div>
                    </div>
                    <button
                      onClick={() => removeAttachment(index)}
                      className="text-red-600 hover:text-red-800 font-bold"
                    >
                      √ó
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        <div className="flex gap-2 pt-4 border-t">
          <button
            onClick={handleSend}
            disabled={sending}
            className="px-4 py-2 text-white rounded-lg hover:opacity-90 disabled:opacity-50"
            style={{ backgroundColor: branding.primary_color }}
          >
            {sending ? 'Sending...' : 'Send Email'}
          </button>
          <button
            onClick={onClose}
            className="px-4 py-2 border rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  )
}

// Email Thread View Component
function EmailThreadView({ thread, account, branding, onReplySuccess, currentFolder }: any) {
  const [replyBody, setReplyBody] = useState('')
  const [replyMode, setReplyMode] = useState<'none' | 'reply' | 'replyAll' | null>(null)
  const [forwarding, setForwarding] = useState<number | null>(null)
  const [forwardTo, setForwardTo] = useState('')
  const [expanded, setExpanded] = useState<number | null>(null)
  const [autoReadTimer, setAutoReadTimer] = useState<NodeJS.Timeout | null>(null)
  const [downloadingAttachmentId, setDownloadingAttachmentId] = useState<string | null>(null)
  const [sending, setSending] = useState(false)

  // Rich text editor
  const editor = useEditor({
    extensions: [
      StarterKit,
      TextAlign.configure({
        types: ['heading', 'paragraph'],
      }),
      ImageExtension,
      LinkExtension.configure({
        openOnClick: false,
      }),
    ],
    content: '',
    editorProps: {
      attributes: {
        class: 'prose prose-sm focus:outline-none max-w-none min-h-[200px] p-3 border rounded-lg focus:ring-2',
      },
    },
  })

  const handleDownloadAttachment = async (emailId: number, attachmentFilename: string, attachmentId?: number) => {
    try {
      setDownloadingAttachmentId(attachmentFilename)
      const token = getAuthToken()
      
      // Try multiple endpoints to support different backend configurations
      let url: string
      if (attachmentId) {
        url = `${API_URL}/email/emails/${emailId}/attachments/${attachmentId}`
      } else {
        // URL-encode the filename to handle special characters
        const encodedFilename = encodeURIComponent(attachmentFilename)
        url = `${API_URL}/email/emails/${emailId}/attachments/${encodedFilename}`
      }
      
      console.log('Downloading attachment from:', url)
      
      const response = await axios.get(url, {
        headers: { Authorization: `Bearer ${token}` },
        responseType: 'blob',
        timeout: 30000
      })
      
      // Verify we got a valid response
      if (!response.data || response.data.size === 0) {
        throw new Error('Empty response received')
      }
      
      // Create a temporary URL and trigger download
      const blob = new Blob([response.data], { type: response.headers['content-type'] || 'application/octet-stream' })
      const downloadUrl = window.URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = downloadUrl
      link.download = attachmentFilename
      link.style.display = 'none'
      document.body.appendChild(link)
      link.click()
      
      // Cleanup
      setTimeout(() => {
        document.body.removeChild(link)
        window.URL.revokeObjectURL(downloadUrl)
      }, 100)
      
      console.log('Attachment downloaded successfully:', attachmentFilename)
    } catch (error: any) {
      console.error('Error downloading attachment:', error)
      const errorMessage = error.response?.status === 404 
        ? 'Attachment not found on server'
        : error.response?.statusText || 'Failed to download attachment'
      alert(`Download failed: ${errorMessage}`)
    } finally {
      setDownloadingAttachmentId(null)
    }
  }

  const toggleEmailRead = async (emailId: number, isRead: boolean) => {
    try {
      const token = getAuthToken()
      const endpoint = isRead ? 'mark-read' : 'mark-unread'
      await axios.put(`${API_URL}/email/emails/${emailId}/${endpoint}?is_read=${isRead}`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      })
      onReplySuccess()
    } catch (error) {
      console.error('Error updating email:', error)
      alert('Failed to update email')
    }
  }

  // Auto-mark as read after 30 seconds when email is expanded
  useEffect(() => {
    if (expanded !== null && thread?.emails[expanded] && !thread.emails[expanded].is_read) {
      // Clear any existing timer
      if (autoReadTimer) clearTimeout(autoReadTimer)
      
      // Set new timer for 30 seconds
      const timer = setTimeout(() => {
        toggleEmailRead(thread.emails[expanded].id, true)
      }, 30000)
      
      setAutoReadTimer(timer)
      
      // Cleanup on unmount or change
      return () => clearTimeout(timer)
    }
  }, [expanded])

  const starEmail = async (emailId: number, isStarred: boolean) => {
    try {
      const token = getAuthToken()
      await axios.put(`${API_URL}/email/emails/${emailId}/star?is_starred=${isStarred}`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      })
      onReplySuccess()
    } catch (error) {
      console.error('Error starring email:', error)
      alert('Failed to star email')
    }
  }

  const deleteEmail = async (emailId: number) => {
    if (!confirm('Are you sure you want to delete this email?')) {
      return
    }

    try {
      const token = getAuthToken()
      await axios.put(`${API_URL}/email/emails/${emailId}/trash`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      })
      alert('Email moved to trash')
      onReplySuccess()
    } catch (error) {
      console.error('Error deleting email:', error)
      alert('Failed to delete email')
    }
  }

  const forwardEmail = (emailId: number, subject: string) => {
    setForwarding(emailId)
  }

  const handleForwardSend = async () => {
    if (!forwardTo || !forwardTo.includes('@')) {
      alert('Please enter a valid email address')
      return
    }

    try {
      setSending(true)
      const token = getAuthToken()
      await axios.post(`${API_URL}/email/emails/${forwarding}/forward?to_address=${forwardTo}&reply_text=`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      })
      alert('Email forwarded successfully')
      setForwarding(null)
      setForwardTo('')
      onReplySuccess()
    } catch (error) {
      console.error('Error forwarding email:', error)
      alert('Failed to forward email')
    } finally {
      setSending(false)
    }
  }

  const handleRetryOutbox = async (emailId: number) => {
    try {
      setSending(true)
      const token = getAuthToken()
      await axios.post(`${API_URL}/email/emails/${emailId}/retry`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      })
      alert('Retrying to send email...')
      onReplySuccess()
    } catch (error) {
      console.error('Error retrying email:', error)
      alert('Failed to retry sending email')
    } finally {
      setSending(false)
    }
  }

  const handleRestoreTrash = async (emailId: number) => {
    try {
      const token = getAuthToken()
      await axios.post(`${API_URL}/email/emails/${emailId}/restore`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      })
      alert('Email restored to inbox')
      onReplySuccess()
    } catch (error) {
      console.error('Error restoring email:', error)
      alert('Failed to restore email')
    }
  }

  const handleReply = async (isReplyAll: boolean = false) => {
    const editorHtml = editor?.getHTML() || ''
    const editorText = editor?.getText() || ''
    
    if (!editorText.trim()) {
      alert('Please write a reply')
      return
    }

    try {
      setSending(true)
      const token = getAuthToken()
      const emailToReplyTo = thread.emails[thread.emails.length - 1]
      
      // Build recipients list
      let toAddresses = isReplyAll 
        ? [emailToReplyTo.from_address, ...emailToReplyTo.to_address.split(',').map((e: string) => e.trim())]
            .filter((v: string, i: number, a: string[]) => a.indexOf(v) === i && v !== account.email_address)
        : [emailToReplyTo.from_address]
      
      const ccAddresses = isReplyAll && emailToReplyTo.cc 
        ? emailToReplyTo.cc.split(',').map((e: string) => e.trim()).filter((v: string) => v !== account.email_address)
        : []

      await axios.post(`${API_URL}/email/emails/${emailToReplyTo.id}/reply`, {
        body: editorHtml,
        to_address: toAddresses.join(','),
        cc: ccAddresses.join(',')
      }, {
        headers: { Authorization: `Bearer ${token}` }
      })
      
      editor?.commands.clearContent()
      setReplyMode(null)
      onReplySuccess()
    } catch (error) {
      console.error('Error sending reply:', error)
      alert('Failed to send reply')
    } finally {
      setSending(false)
    }
  }

  const handleSaveDraft = async () => {
    if (!replyBody.trim()) {
      alert('Please write a draft')
      return
    }

    try {
      setSending(true)
      const token = getAuthToken()
      const emailToReplyTo = thread.emails[thread.emails.length - 1]
      
      await axios.post(`${API_URL}/email/emails/${emailToReplyTo.id}/draft`, {
        body: replyBody
      }, {
        headers: { Authorization: `Bearer ${token}` }
      })
      
      setReplyBody('')
      alert('Draft saved successfully!')
      onReplySuccess()
    } catch (error) {
      console.error('Error saving draft:', error)
      alert('Failed to save draft')
    } finally {
      setSending(false)
    }
  }

  const lastEmail = thread.emails[thread.emails.length - 1]
  
  if (!lastEmail) {
    return (
      <div className="p-6">
        <div className="text-center text-gray-500">
          No emails in thread
        </div>
      </div>
    )
  }

  return (
    <div className="p-6 space-y-4">
      {/* Thread Header */}
      <div className="bg-white rounded-lg p-4 border">
        <h1 className="text-2xl font-bold mb-2">{thread.subject}</h1>
        <div className="text-sm text-gray-600">
          <div>{thread.reply_count} replies</div>
          <div>Started {new Date(thread.first_email_at).toLocaleString()}</div>
        </div>
      </div>

      {/* Emails in Thread */}
      <div className="space-y-3">
        {thread.emails.map((email: Email, idx: number) => (
          <div key={email.id} className="bg-white rounded-lg border overflow-hidden">
            <button
              onClick={() => {
                setExpanded(expanded === idx ? null : idx)
              }}
              className="w-full text-left p-4 hover:bg-gray-50 flex justify-between items-start"
            >
              <div className="flex-1">
                <div className="flex items-center gap-2 flex-wrap">
                  <span className="font-medium text-sm">{email.from_address}</span>
                  {email.is_sent && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Sent</span>}
                  {!email.is_read && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">Unread</span>}
                  {email.attachments && email.attachments.length > 0 && <span className="text-sm">üìé {email.attachments.length}</span>}
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  {new Date(email.received_at).toLocaleString()}
                </div>
              </div>
              <span className="text-gray-400 ml-2">{expanded === idx ? '‚ñº' : '‚ñ∂'}</span>
            </button>

            {expanded === idx && (
              <div className={`border-t p-4 space-y-3 ${!email.is_read ? 'bg-blue-50' : 'bg-gray-50'}`}>
                {/* Email Headers */}
                <div className="bg-white p-3 rounded border space-y-2 text-sm">
                  <div>
                    <span className="text-gray-600 font-medium">From:</span>
                    <p className="text-gray-900">{email.from_address}</p>
                  </div>
                  <div>
                    <span className="text-gray-600 font-medium">To:</span>
                    <p className="text-gray-900">{email.to_address}</p>
                  </div>
                  {email.cc && (
                    <div>
                      <span className="text-gray-600 font-medium">CC:</span>
                      <p className="text-gray-900">{email.cc}</p>
                    </div>
                  )}
                  {email.bcc && (
                    <div>
                      <span className="text-gray-600 font-medium">BCC:</span>
                      <p className="text-gray-900">{email.bcc}</p>
                    </div>
                  )}
                </div>

                {email.attachments && email.attachments.length > 0 && (
                  <div className="bg-gray-100 p-3 rounded border">
                    <div className="text-xs font-semibold text-gray-700 mb-2">üìé Attachments ({email.attachments.length})</div>
                    <div className="space-y-2">
                      {email.attachments.map((attachment, i) => (
                        <div key={i} className="flex items-center justify-between bg-white p-2 rounded text-xs">
                          <div className="flex-1 min-w-0">
                            <div className="font-medium truncate">{attachment.filename}</div>
                            <div className="text-gray-500">{(attachment.size / 1024).toFixed(2)} KB</div>
                          </div>
                          <button
                            onClick={() => handleDownloadAttachment(email.id, attachment.filename, attachment.id)}
                            disabled={downloadingAttachmentId === attachment.filename}
                            className="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            {downloadingAttachmentId === attachment.filename ? '‚è≥' : '‚¨áÔ∏è'}
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                <div className="bg-white p-3 rounded border">
                  <div
                    dangerouslySetInnerHTML={{
                      __html: email.body_html || email.body_text || 'No content'
                    }}
                  />
                </div>

                {/* Email Actions */}
                <div className="flex gap-2 pt-3 border-t flex-wrap">
                  <button
                    onClick={() => toggleEmailRead(email.id, !email.is_read)}
                    className="px-3 py-1 text-sm rounded border hover:bg-gray-100 flex items-center gap-1"
                  >
                    {email.is_read ? 'üëÅÔ∏è Mark Unread' : '‚úì Mark Read'}
                  </button>
                  <button
                    onClick={() => forwardEmail(email.id, email.subject)}
                    className="px-3 py-1 text-sm rounded border hover:bg-gray-100 flex items-center gap-1"
                  >
                    ‚Ü™Ô∏è Forward
                  </button>
                  {currentFolder === 'outbox' && (
                    <button
                      onClick={() => handleRetryOutbox(email.id)}
                      disabled={sending}
                      className="px-3 py-1 text-sm rounded border border-orange-200 text-orange-600 hover:bg-orange-50 disabled:opacity-50 flex items-center gap-1"
                    >
                      üîÑ Retry
                    </button>
                  )}
                  {currentFolder === 'trash' && (
                    <button
                      onClick={() => handleRestoreTrash(email.id)}
                      className="px-3 py-1 text-sm rounded border border-green-200 text-green-600 hover:bg-green-50 flex items-center gap-1"
                    >
                      ‚Ü©Ô∏è Restore
                    </button>
                  )}
                  <button
                    onClick={() => deleteEmail(email.id)}
                    className="px-3 py-1 text-sm rounded border border-red-200 text-red-600 hover:bg-red-50 flex items-center gap-1"
                  >
                    üóëÔ∏è Delete
                  </button>
                  <button
                    onClick={() => starEmail(email.id, !email.is_starred)}
                    className="px-3 py-1 text-sm rounded border hover:bg-gray-100 flex items-center gap-1"
                  >
                    {email.is_starred ? '‚≠ê Unstar' : '‚òÜ Star'}
                  </button>
                </div>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* Reply Composer */}
      {replyMode && (
        <div className="bg-white rounded-lg p-4 border space-y-3">
          <h3 className="font-semibold text-sm">
            {replyMode === 'replyAll' ? `Reply All to ${lastEmail.from_address}` : `Reply to ${lastEmail.from_address}`}
          </h3>
          
          {/* Rich Text Toolbar */}
          <div className="border rounded-lg bg-gray-50 p-2 flex flex-wrap gap-1">
            <button
              onClick={() => editor?.chain().focus().toggleBold().run()}
              disabled={!editor?.can().chain().focus().toggleBold().run()}
              className={`px-3 py-1 rounded text-sm font-bold ${editor?.isActive('bold') ? 'bg-gray-800 text-white' : 'bg-white border'}`}
              title="Bold"
            >
              B
            </button>
            <button
              onClick={() => editor?.chain().focus().toggleItalic().run()}
              disabled={!editor?.can().chain().focus().toggleItalic().run()}
              className={`px-3 py-1 rounded text-sm italic ${editor?.isActive('italic') ? 'bg-gray-800 text-white' : 'bg-white border'}`}
              title="Italic"
            >
              I
            </button>
            <button
              onClick={() => editor?.chain().focus().toggleUnderline().run()}
              className={`px-3 py-1 rounded text-sm underline ${editor?.isActive('underline') ? 'bg-gray-800 text-white' : 'bg-white border'}`}
              title="Underline"
            >
              U
            </button>
            <div className="border-l border-gray-300 mx-1"></div>
            <button
              onClick={() => editor?.chain().focus().toggleBulletList().run()}
              className={`px-3 py-1 rounded text-sm ${editor?.isActive('bulletList') ? 'bg-gray-800 text-white' : 'bg-white border'}`}
              title="Bullet List"
            >
              ‚Ä¢ List
            </button>
            <button
              onClick={() => editor?.chain().focus().toggleOrderedList().run()}
              className={`px-3 py-1 rounded text-sm ${editor?.isActive('orderedList') ? 'bg-gray-800 text-white' : 'bg-white border'}`}
              title="Ordered List"
            >
              1. List
            </button>
            <div className="border-l border-gray-300 mx-1"></div>
            <button
              onClick={() => editor?.chain().focus().setTextAlign('left').run()}
              className={`px-3 py-1 rounded text-sm ${editor?.isActive({ textAlign: 'left' }) ? 'bg-gray-800 text-white' : 'bg-white border'}`}
              title="Align Left"
            >
              ‚¨Ö
            </button>
            <button
              onClick={() => editor?.chain().focus().setTextAlign('center').run()}
              className={`px-3 py-1 rounded text-sm ${editor?.isActive({ textAlign: 'center' }) ? 'bg-gray-800 text-white' : 'bg-white border'}`}
              title="Align Center"
            >
              ‚ãÆ
            </button>
            <button
              onClick={() => editor?.chain().focus().setTextAlign('right').run()}
              className={`px-3 py-1 rounded text-sm ${editor?.isActive({ textAlign: 'right' }) ? 'bg-gray-800 text-white' : 'bg-white border'}`}
              title="Align Right"
            >
              ‚û°
            </button>
          </div>

          {/* Rich Text Editor */}
          <EditorContent editor={editor} />

          <div className="flex gap-2 flex-wrap">
            <button
              onClick={() => handleReply(replyMode === 'replyAll')}
              disabled={sending}
              className="px-4 py-2 text-white rounded-lg hover:opacity-90 disabled:opacity-50"
              style={{ backgroundColor: branding.primary_color }}
            >
              {sending ? 'Sending...' : 'Send'}
            </button>
            <button
              onClick={() => setReplyMode(null)}
              className="px-4 py-2 text-gray-700 rounded-lg border border-gray-300 hover:bg-gray-50"
            >
              Cancel
            </button>
          </div>
        </div>
      )}

      {/* Reply/Reply All Buttons */}
      {!replyMode && (
        <div className="flex gap-2">
          <button
            onClick={() => setReplyMode('reply')}
            className="px-4 py-2 text-white rounded-lg hover:opacity-90"
            style={{ backgroundColor: branding.primary_color }}
          >
            ‚Ü©Ô∏è Reply
          </button>
          <button
            onClick={() => setReplyMode('replyAll')}
            className="px-4 py-2 text-white rounded-lg hover:opacity-90"
            style={{ backgroundColor: branding.primary_color }}
          >
            ‚Ü©Ô∏è‚Ü©Ô∏è Reply All
          </button>
        </div>
      )}

      {/* Forward Modal */}
      {forwarding && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-96 shadow-lg">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold">Forward Email</h3>
              <button
                onClick={() => setForwarding(null)}
                className="text-gray-500 hover:text-gray-700 text-xl"
              >
                ‚úï
              </button>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Forward to:
                </label>
                <input
                  type="email"
                  value={forwardTo}
                  onChange={(e) => setForwardTo(e.target.value)}
                  placeholder="recipient@example.com"
                  className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2"
                />
              </div>

              <div className="flex gap-2">
                <button
                  onClick={handleForwardSend}
                  disabled={sending}
                  className="flex-1 px-4 py-2 text-white rounded-lg hover:opacity-90 disabled:opacity-50"
                  style={{ backgroundColor: branding.primary_color }}
                >
                  {sending ? 'Forwarding...' : 'Forward'}
                </button>
                <button
                  onClick={() => setForwarding(null)}
                  className="px-4 py-2 border rounded-lg hover:bg-gray-50"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
